on:
  workflow_dispatch:
    branches:
      - master
name: 🖥️ Auto-deploy on Development
jobs:
  sync_files:
    name: 📂 Sync files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: FTP upload
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: ${{ secrets.ftp_server_dir_dev }}

  create_supporting_file:
    needs: sync_files
    name: ⚙️ Create support file
    runs-on: ubuntu-latest
    steps:
      - name: Create htaccess, index, env file, and install dependencies
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.server }}
          username: ${{ secrets.ssh_username }}
          password: ${{ secrets.ssh_password }}
          port: ${{ secrets.ssh_port }}
          script:
            cp -n ${{ secrets.path_domain }}${{ secrets.ftp_server_dir_dev }}public/.htaccess ${{ secrets.path_domain }}${{ secrets.ftp_server_dir_dev }} &&
            chmod -R 777 ${{ secrets.path_domain }}${{ secrets.ftp_server_dir_dev }} &&
            cd ${{ secrets.path_domain }}${{ secrets.ftp_server_dir_dev }} &&
            if stat index.php;
            then echo "File exists";
            else touch index.php &&
            truncate -s 0 index.php &&
            echo "<?php" >> index.php &&
            echo "include('public/index.php');" >> index.php;
            fi &&
            touch .env &&
            truncate -s 0 .env &&
            echo "CI_ENVIRONMENT = development" >> .env &&
            echo "secret.key = ${{ secrets.env_key_dev }}" >> .env &&
            echo "database.default.hostname = localhost" >> .env &&
            echo "database.default.database = ${{ secrets.env_database_dev }}" >> .env &&
            echo "database.default.username = ${{ secrets.env_username_dev }}" >> .env &&
            echo "database.default.password = ${{ secrets.env_password_dev }}" >> .env &&
            echo "database.default.DBDriver = MySQLi" >> .env &&
            echo "database.default.DBPrefix = " >> .env &&
            echo "database.default.port = 3306" >> .env &&
            php ./composer.phar install &&
            chmod -R 755 .
